<!DOCTYPE html>
<html class="light" lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Pagina do Optometrista - Financeiro</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&amp;display=swap"
    rel="stylesheet" />
  <!-- Material Symbols -->
  <link
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
    rel="stylesheet" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#13ecec",
            "primary-dark": "#0ebdbd",
            "background-light": "#f6f8f8",
            "background-dark": "#102222",
            "surface-light": "#ffffff",
            "surface-dark": "#182d2d",
            "text-main": "#0d1b1b",
            "text-sub": "#4c9a9a",
          },
          fontFamily: {
            "display": ["Inter", "sans-serif"],
            "sans": ["Inter", "sans-serif"],
          },
          borderRadius: { "DEFAULT": "0.5rem", "lg": "0.75rem", "xl": "1rem", "2xl": "1.5rem", "full": "9999px" },
        },
      },
    }
  </script>
</head>

<body
  class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100 antialiased overflow-hidden">
  <div class="flex h-screen w-full">
    <!-- Side Navigation -->
    <aside id="app-sidebar"
      class="w-64 flex-shrink-0 border-r border-slate-200 dark:border-slate-800 bg-surface-light dark:bg-surface-dark flex flex-col transition-colors duration-200 hidden md:flex">
      <div class="p-6">
        <div class="flex items-center gap-3 mb-8">
          <div class="bg-primary/20 p-2 rounded-lg">
            <span class="material-symbols-outlined text-primary-dark dark:text-primary text-3xl">visibility</span>
          </div>
          <div class="flex flex-col">
            <h1 class="text-base font-bold leading-tight text-slate-900 dark:text-white">Pagina do Optometrista</h1>
            <span class="text-xs font-medium text-slate-500 dark:text-slate-400">Versão 04/jan/2026</span>
          </div>
        </div>
        <div
          class="flex flex-col gap-3 p-3 rounded-xl bg-slate-50 dark:bg-slate-800/50 mb-6 border border-slate-100 dark:border-slate-700">
          <div class="flex gap-3 items-center">
            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 ring-2 ring-primary/20"
              id="sidebar-clinic-logo" data-alt="Clinic logo showing an abstract eye symbol"
              style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuC4BJtPUvZewU_Krp1QI84SkqsltswXTpXlOwS9HgWPxhTdWG9LxYOMSsZptM4Zc3fWMmOcCcOyFFzHTsGN0k3b9zgS-ahr2QmCPEdq5GbH9e7j4Q3uTP2aoQvTmJjmgl2YGYbUKNj4akWaC3DfB1QitER0bqu_iICaYCrYxu66Dwb9thCLDMHrlypm0NdpKA08ILyrMcCOVDJo1N4Inl5oW9lqh3cg4erKd4eWd2i7O62r3dR_y2UmlfXXjJsKNn1CovSRG8HGI7kH");'>
            </div>
            <div class="flex flex-col overflow-hidden">
              <h2 id="sidebar-clinic-name"
                class="text-sm font-semibold truncate text-slate-900 dark:text-white min-h-[20px]"></h2>
              <p class="text-xs text-slate-500 dark:text-slate-400 truncate min-h-[16px]" id="sidebar-clinic-social">
              </p>
            </div>
          </div>
        </div>
        <nav class="flex flex-col gap-1">
          <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors"
            href="Pagina - Dashboard.html">
            <span class="material-symbols-outlined">dashboard</span>
            <span class="text-sm font-medium">Dashboard</span>
          </a>
          <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors"
            href="Pagina - Pacientes.html">
            <span class="material-symbols-outlined">groups</span>
            <span class="text-sm font-medium">Pacientes</span>
          </a>
          <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors"
            href="Pagina - Agenda.html">
            <span class="material-symbols-outlined">calendar_month</span>
            <span class="text-sm font-medium">Agenda</span>
          </a>
          <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-primary/10 text-slate-900 dark:text-white group"
            href="Pagina - Financeiro.html">
            <span class="material-symbols-outlined text-primary-dark dark:text-primary fill-1">payments</span>
            <span class="text-sm font-semibold">Financeiro</span>
          </a>
        </nav>
      </div>
      <div class="mt-auto p-6 border-t border-slate-100 dark:border-slate-800">
        <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors"
          href="Pagina - Configuracoes.html">
          <span class="material-symbols-outlined">settings</span>
          <span class="text-sm font-medium">Configurações</span>
        </a>
        <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/10 text-slate-600 dark:text-slate-400 hover:text-red-600 dark:hover:text-red-400 transition-colors mt-1"
          href="Login - Pagina Inicial.html">
          <span class="material-symbols-outlined">logout</span>
          <span class="text-sm font-medium">Sair</span>
        </a>
      </div>
    </aside>
    <!-- Main Content Wrapper -->
    <div
      class="flex-1 flex flex-col h-full min-w-0 bg-background-light dark:bg-background-dark overflow-hidden relative">
      <!-- Top Header -->
      <header
        class="h-16 flex items-center justify-between px-6 py-3 bg-surface-light dark:bg-surface-dark border-b border-slate-200 dark:border-slate-800 shrink-0 z-20">
        <div class="flex items-center gap-4 lg:hidden">
          <button id="mobile-menu-btn" class="p-2 -ml-2 text-slate-600 dark:text-slate-300">
            <span class="material-symbols-outlined">menu</span>
          </button>
        </div>
        <!-- Right Actions -->
        <div class="flex items-center gap-3 ml-auto">
          <button onclick="window.location.href='Cadastro Novo Paciente.html'"
            class="flex items-center justify-center h-10 px-4 gap-2 rounded-xl bg-primary text-slate-900 font-bold shadow-lg shadow-primary/20 hover:brightness-105 transition-all">
            <span class="material-symbols-outlined text-[20px]">add</span>
            <span class="hidden sm:inline">Novo Paciente</span>
          </button>
          <div class="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-1"></div>
          <div class="flex items-center gap-3 pl-2 ml-2 border-l border-slate-200 dark:border-slate-700">
            <div class="text-right">
              <p id="header-user-name" class="text-sm font-bold text-slate-900 dark:text-white">Carregando...</p>
              <p id="header-user-role" class="text-xs text-slate-500 dark:text-slate-400">...</p>
            </div>
          </div>
        </div>
      </header>
      <!-- Scrollable Page Content -->
      <div class="flex-1 overflow-y-auto p-8 scroll-smooth">
        <div class="max-w-7xl mx-auto flex flex-col gap-8">
          <!-- Page Heading & Actions -->
          <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
            <div class="flex flex-col gap-1">
              <div class="flex items-center gap-2 text-primary font-medium text-sm mb-1">
                <span class="material-symbols-outlined text-[18px]">trending_up</span>
                <span>Visão Geral</span>
              </div>
              <h1 class="text-3xl font-black tracking-tight text-slate-900 dark:text-white">Gestão Financeira</h1>
              <p class="text-slate-500 dark:text-slate-400 max-w-2xl">Acompanhe o faturamento, recebíveis de convênios e
                fluxo de caixa da clínica.</p>
            </div>
            <div class="flex items-center gap-3">
              <button onclick="window.location.href='Nova Transação Financeira.html'"
                class="px-5 py-2.5 rounded-xl bg-primary text-slate-900 font-bold text-sm hover:bg-[#0fdada] shadow-lg shadow-primary/20 transition-all flex items-center gap-2">
                <span class="material-symbols-outlined text-[20px]">add</span>
                Nova Transação
              </button>
            </div>
          </div>
          <!-- Stats Grid -->
          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
            <!-- Card 1 -->
            <div
              class="bg-surface-light dark:bg-surface-dark p-6 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col justify-between h-40 group hover:border-primary/50 transition-colors">
              <div class="flex justify-between items-start">
                <div
                  class="p-2 bg-slate-100 dark:bg-slate-800 rounded-lg text-slate-600 dark:text-slate-400 group-hover:text-primary transition-colors">
                  <span class="material-symbols-outlined">payments</span>
                </div>
              </div>
              <div>
                <p class="text-slate-500 dark:text-slate-400 text-sm font-medium mb-1">Entradas (Total)</p>
                <h3 id="stat-total-income" class="text-2xl font-bold text-slate-900 dark:text-white">R$ 0,00</h3>
              </div>
            </div>
            <!-- Card 2 -->
            <div
              class="bg-surface-light dark:bg-surface-dark p-6 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col justify-between h-40 group hover:border-primary/50 transition-colors">
              <div class="flex justify-between items-start">
                <div
                  class="p-2 bg-slate-100 dark:bg-slate-800 rounded-lg text-slate-600 dark:text-slate-400 group-hover:text-primary transition-colors">
                  <span class="material-symbols-outlined">account_balance_wallet</span>
                </div>
              </div>
              <div>
                <p class="text-slate-500 dark:text-slate-400 text-sm font-medium mb-1">Pendente</p>
                <h3 id="stat-total-pending" class="text-2xl font-bold text-slate-900 dark:text-white">R$ 0,00</h3>
              </div>
            </div>
            <!-- Card 3 -->
            <div
              class="bg-surface-light dark:bg-surface-dark p-6 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col justify-between h-40 group hover:border-primary/50 transition-colors">
              <div class="flex justify-between items-start">
                <div
                  class="p-2 bg-slate-100 dark:bg-slate-800 rounded-lg text-slate-600 dark:text-slate-400 group-hover:text-primary transition-colors">
                  <span class="material-symbols-outlined">analytics</span>
                </div>
              </div>
              <div>
                <p class="text-slate-500 dark:text-slate-400 text-sm font-medium mb-1">Saldo Líquido</p>
                <h3 id="stat-net-balance" class="text-2xl font-bold text-slate-900 dark:text-white">R$ 0,00</h3>
              </div>
            </div>
            <!-- Card 4 -->
            <div
              class="bg-surface-light dark:bg-surface-dark p-6 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col justify-between h-40 group hover:border-primary/50 transition-colors">
              <div class="flex justify-between items-start">
                <div
                  class="p-2 bg-slate-100 dark:bg-slate-800 rounded-lg text-slate-600 dark:text-slate-400 group-hover:text-primary transition-colors">
                  <span class="material-symbols-outlined">credit_card</span>
                </div>
              </div>
              <div>
                <p class="text-slate-500 dark:text-slate-400 text-sm font-medium mb-1">Despesas</p>
                <h3 id="stat-total-expense" class="text-2xl font-bold text-slate-900 dark:text-white">R$ 0,00</h3>
              </div>
            </div>
          </div>
          <!-- Main Content Section: Filters and Table -->
          <div
            class="bg-surface-light dark:bg-surface-dark border border-slate-200 dark:border-slate-800 rounded-2xl shadow-sm overflow-hidden flex flex-col">

            <!-- Filters Bar -->
            <div
              class="px-6 py-4 border-b border-slate-200 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-800/10 flex flex-wrap gap-4 items-end">
              <div>
                <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Data Início</label>
                <input type="date" id="filter-date-start"
                  class="px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-900 dark:text-white text-sm focus:ring-2 focus:ring-primary/50 outline-none">
              </div>
              <div>
                <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Data Fim</label>
                <input type="date" id="filter-date-end"
                  class="px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-900 dark:text-white text-sm focus:ring-2 focus:ring-primary/50 outline-none">
              </div>
              <div>
                <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Caixa / Método</label>
                <select id="filter-method"
                  class="px-3 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-900 dark:text-white text-sm min-w-[150px] focus:ring-2 focus:ring-primary/50 outline-none cursor-pointer">
                  <option value="all">Todos</option>
                  <option value="Dinheiro">Dinheiro</option>
                  <option value="Pix">Pix</option>
                  <option value="Cartão">Cartão</option>
                </select>
              </div>
              <button id="btn-filter"
                class="px-4 py-2 bg-primary text-slate-900 text-sm font-bold rounded-lg hover:brightness-105 transition-colors shadow-sm mb-[1px]">
                Filtrar
              </button>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full text-left border-collapse">
                <thead>
                  <tr class="bg-slate-50 dark:bg-slate-800/10 border-b border-slate-200 dark:border-slate-800">
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                      Descrição</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                      Categoria</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                      Data</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                      Valor</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                      Status</th>
                    <th
                      class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right">
                      Ações</th>
                  </tr>
                </thead>
                <tbody id="transactions-list" class="divide-y divide-slate-200 dark:divide-slate-800">
                  <!-- Dynamic Content Here -->
                  <tr>
                    <td colspan="5" class="px-6 py-12 text-center text-slate-500">Carregando dados...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
      (function () {
        try {
          const cached = sessionStorage.getItem('user_profile_cache');
          if (cached) {
            const profile = JSON.parse(cached);
            const hName = document.getElementById('header-user-name');
            const hRole = document.getElementById('header-user-role');
            if (hName) hName.textContent = profile.full_name || 'Usuário';

            const roleMap = { 'admin': 'Administrador', 'optometrist': 'Optometrista', 'secretary': 'Recepcionista' };
            if (hRole) hRole.textContent = roleMap[profile.role] || profile.role || 'Membro da Equipe';

            const sbName = document.getElementById('sidebar-clinic-name');
            const sbSocial = document.getElementById('sidebar-clinic-social');
            const sbLogo = document.getElementById('sidebar-clinic-logo');
            if (profile.clinics) {
              if (sbName) sbName.textContent = profile.clinics.name;
              if (sbSocial) sbSocial.textContent = profile.clinics.social_name;
              if (sbLogo && profile.clinics.logo_url) sbLogo.style.backgroundImage = `url("${profile.clinics.logo_url}")`;
            }
          }
        } catch (e) { console.error('Fast render error', e); }
      })();
  </script>
  <script type="module">
    import { supabase } from './js/supabase-client.js';
    import { loadSidebar } from './js/sidebar-loader.js';

    loadSidebar();

    const transactionsList = document.getElementById('transactions-list');
    const userNameDisplay = document.getElementById('header-user-name');
    const userRoleDisplay = document.getElementById('header-user-role');

    const statTotalIncome = document.getElementById('stat-total-income');
    const statTotalExpense = document.getElementById('stat-total-expense');
    const statNetBalance = document.getElementById('stat-net-balance');
    const statPending = document.getElementById('stat-total-pending');



    function updateStats(transactions) {
      let income = 0;
      let expense = 0;
      let pending = 0;

      transactions.forEach(t => {
        const val = parseFloat(t.amount);
        if (t.type === 'income') {
          income += val;
        } else {
          expense += val;
        }
        if (t.status === 'pending') {
          pending += val;
        }
      });

      const net = income - expense;

      const fmt = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);

      statTotalIncome.textContent = fmt(income);
      statTotalExpense.textContent = fmt(expense);
      statNetBalance.textContent = fmt(net);
      statPending.textContent = fmt(pending);
    }

    // --- INITIALIZATION ---
    // Set Default Dates (Current Month)
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];

    const startInput = document.getElementById('filter-date-start');
    const endInput = document.getElementById('filter-date-end');
    const filterBtn = document.getElementById('btn-filter');

    if (startInput) startInput.value = firstDay;
    if (endInput) endInput.value = lastDay;

    // Attach Filter Listener
    if (filterBtn) {
      filterBtn.addEventListener('click', () => loadFinance());
    }

    // Expose delete function globally
    window.deleteTransaction = async (id, isAppt) => {
      if (!confirm('Tem certeza que deseja excluir este registro permanentemente?')) return;

      try {
        const table = isAppt ? 'appointments' : 'transactions';
        const { error } = await supabase.from(table).delete().eq('id', id);

        if (error) throw error;

        alert('Registro excluído com sucesso.');
        loadFinance(); // Reload
      } catch (err) {
        console.error(err);
        alert('Erro ao excluir: ' + err.message);
      }
    };

    let currentUserRole = null;

    async function loadFinance() {
      try {
        transactionsList.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-slate-500">Carregando dados...</td></tr>';

        // 1. Auth & Profile
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          window.location.href = 'Login - Pagina Inicial.html';
          return;
        }

        const { data: profile } = await supabase
          .from('profiles')
          .select('*, clinics(name, social_name)')
          .eq('id', session.user.id)
          .single();

        if (profile) {
          currentUserRole = profile.role;
          loadSidebar();
        }

        // Get Filter Values
        const startDate = startInput ? startInput.value : firstDay;
        const endDate = endInput ? endInput.value : lastDay;
        const methodFilter = document.getElementById('filter-method').value;

        // 2. Fetch Transactions (Filtered)
        let tQuery = supabase
          .from('transactions')
          .select('*')
          .eq('clinic_id', profile.clinic_id)
          .gte('date', startDate)
          .lte('date', endDate)
          .order('date', { ascending: false });

        // Apply method filter if needed (if method column exists, assuming mixed logic for now)

        const { data: transactions, error: tErr } = await tQuery;
        if (tErr) throw tErr;

        // 3. Fetch Appointments with Price (Filtered)
        const { data: appointments, error: aErr } = await supabase
          .from('appointments')
          .select('*, patients(full_name)')
          .eq('clinic_id', profile.clinic_id)
          .not('price', 'is', null)
          .gt('price', 0)
          .gte('date', startDate)
          .lte('date', endDate)
          .order('date', { ascending: false });

        if (aErr) throw aErr;

        // 4. Merge Data
        const mappedAppts = (appointments || []).map(a => {
          let status = a.payment_status || 'pending';
          if (a.status === 'cancelled' || a.status === 'no_show') status = 'cancelled';

          const typeMap = { 'pediatric': 'Pediátrica', 'functional': 'Funcional', 'neuro': 'Neuro-Comportamental', 'trv': 'TRV', 'general': 'Geral' };
          const typeLabel = typeMap[a.type] || a.type;

          return {
            id: a.id,
            description: `Consulta - ${a.patients?.full_name || 'Paciente'}`,
            category: `Consulta (${typeLabel})`,
            date: a.date,
            amount: a.price,
            type: 'income',
            status: status,
            method: a.payment_method,
            is_appointment: true
          };
        });

        let allItems = [...(transactions || []), ...mappedAppts].sort((a, b) => new Date(b.date) - new Date(a.date));

        // Client-side Method Filter (because methods can be in different columns or json)
        if (methodFilter !== 'all') {
          allItems = allItems.filter(item => (item.method || '').toLowerCase().includes(methodFilter.toLowerCase()));
        }

        if (allItems.length === 0) {
          transactionsList.innerHTML = `<tr><td colspan='6' class='px-6 py-12 text-center text-slate-500'>Nenhuma transação encontrada neste período.</td></tr>`;
          updateStats([]);
          return;
        }

        // 5. Render
        transactionsList.innerHTML = allItems.map(t => {
          const isIncome = t.type === 'income';
          const colorClass = isIncome ? 'text-emerald-600 dark:text-emerald-400' : 'text-rose-600 dark:text-rose-400';
          const amountFormatted = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(t.amount);
          const dateFormatted = new Date(t.date).toLocaleDateString('pt-BR');
          const methodLabel = t.method ? `<br><span class="text-[10px] text-slate-400 uppercase">${t.method}</span>` : '';

          let statusBadge = '';
          if (t.status === 'paid' && t.is_appointment) {
            statusBadge = `<button onclick="openPayment('${t.id}', '${t.amount}')" class="inline-flex flex-col items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-300 hover:bg-emerald-200 cursor-pointer">Pago ${methodLabel}</button>`;
          }
          else if (t.status === 'paid') {
            statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-300">Pago</span>';
          }
          else if (t.status === 'pending' && t.is_appointment) {
            statusBadge = `<button onclick="openPayment('${t.id}', '${t.amount}')" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-300 hover:brightness-95 cursor-pointer ring-1 ring-amber-500/20">Receber</button>`;
          }
          else if (t.status === 'pending') {
            statusBadge = '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-300">Pendente</span>';
          }
          else statusBadge = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-800 dark:bg-slate-800 dark:text-slate-300">${t.status}</span>`;

          // Admin Action
          const deleteBtn = currentUserRole === 'admin'
            ? `<button onclick="deleteTransaction('${t.id}', ${t.is_appointment || false})" class="text-slate-400 hover:text-red-500 p-1 rounded transition-colors" title="Excluir"><span class="material-symbols-outlined text-[18px]">delete</span></button>`
            : '';

          return `
                    <tr class="group hover:bg-slate-50 dark:hover:bg-slate-800/20 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap"><span class="text-sm font-medium text-slate-900 dark:text-white">${t.description}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="text-sm text-slate-500 dark:text-slate-400">${t.category || '-'}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="text-sm text-slate-500 dark:text-slate-400">${dateFormatted}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap"><span class="text-sm font-bold ${colorClass}">${isIncome ? '+' : '-'} ${amountFormatted}</span></td>
                        <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">${deleteBtn}</td>
                    </tr>`;
        }).join('');

        updateStats(allItems);

      } catch (err) {
        console.error(err);
        transactionsList.innerHTML = "<tr><td colspan='6'>Erro inesperado</td></tr>";
      }
    }

    loadFinance();

    // --- PAYMENT MODAL LOGIC ---
    let currentPayApptId = null;

    window.openPayment = (id, amount) => {
      currentPayApptId = id;

      let modal = document.getElementById('payment-modal');
      if (!modal) {
        const html = `
             <div id="payment-modal" class="fixed inset-0 z-[60] hidden">
                <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closePayment()"></div>
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white dark:bg-surface-light p-6 rounded-xl shadow-xl w-full max-w-sm">
                    <h3 class="font-bold text-lg mb-4 text-slate-900 dark:text-white">Receber Pagamento</h3>
                    <p class="text-sm text-slate-500 mb-4">Selecione a forma de pagamento:</p>
                    
                    <div class="flex flex-col gap-2">
                        <button onclick="confirmPayment('dinheiro')" class="p-3 rounded-lg border border-slate-200 hover:bg-emerald-50 hover:border-emerald-200 text-left font-bold text-slate-700 flex justify-between items-center group">
                            <span>Dinheiro / Pix</span>
                            <span class="material-symbols-outlined text-emerald-500 opacity-0 group-hover:opacity-100">check</span>
                        </button>
                        <button onclick="confirmPayment('cartao_credito')" class="p-3 rounded-lg border border-slate-200 hover:bg-blue-50 hover:border-blue-200 text-left font-bold text-slate-700 flex justify-between items-center group">
                            <span>Cartão de Crédito</span>
                            <span class="material-symbols-outlined text-blue-500 opacity-0 group-hover:opacity-100">credit_card</span>
                        </button>
                        <button onclick="confirmPayment('cartao_debito')" class="p-3 rounded-lg border border-slate-200 hover:bg-blue-50 hover:border-blue-200 text-left font-bold text-slate-700 flex justify-between items-center group">
                            <span>Cartão de Débito</span>
                            <span class="material-symbols-outlined text-blue-500 opacity-0 group-hover:opacity-100">credit_card</span>
                        </button>
                    </div>

                    <div class="pt-4 mt-2 border-t border-slate-100">
                         <button onclick="closePayment()" class="w-full text-slate-500 hover:text-slate-800 text-sm font-medium py-2">Cancelar</button>
                    </div>
                </div>
            </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
        modal = document.getElementById('payment-modal');
      }
      document.getElementById('payment-modal').classList.remove('hidden');
    };

    window.closePayment = () => {
      const m = document.getElementById('payment-modal');
      if (m) m.classList.add('hidden');
    };

    window.confirmPayment = async (method) => {
      if (!currentPayApptId) return;

      try {
        const { error } = await supabase
          .from('appointments')
          .update({
            payment_status: 'paid',
            payment_method: method
          })
          .eq('id', currentPayApptId);

        if (error) throw error;

        closePayment();
        loadFinance(); // reload
      } catch (err) {
        console.error(err);
        alert('Erro ao salvar pagamento: ' + err.message);
      }
    };
  </script>
</body>

</html>