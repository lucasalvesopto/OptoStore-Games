<!DOCTYPE html>
<html class="light" lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Controle de Processamento Visual</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ecec",
                        "primary-dark": "#0ebdbd",
                        "background-light": "#f6f8f8",
                        "background-dark": "#102222",
                        "surface-light": "#ffffff",
                        "surface-dark": "#182d2d",
                        "text-main": "#0d1b1b",
                        "text-sub": "#4c9a9a",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"],
                        "sans": ["Inter", "sans-serif"],
                    },
                    borderRadius: { "DEFAULT": "0.5rem", "lg": "0.75rem", "xl": "1rem", "2xl": "1.5rem", "full": "9999px" },
                },
            },
        }
    </script>
</head>

<body
    class="bg-background-light dark:bg-background-dark text-text-main dark:text-gray-100 font-display transition-colors duration-200">
    <div class="flex h-screen w-full overflow-hidden">
        <!-- Sidebar will be loaded dynamically -->
        <aside id="app-sidebar"
            class="w-64 flex-shrink-0 border-r border-slate-200 dark:border-slate-800 bg-surface-light dark:bg-surface-dark flex flex-col transition-colors duration-200 hidden md:flex">
            <div class="p-6">
                <!-- Placeholder for Sidebar -->
                <p class="text-xs text-slate-400">Carregando menu...</p>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex flex-col flex-1 h-full overflow-hidden relative">
            <!-- Header -->
            <header
                class="h-16 flex items-center justify-between px-6 py-3 bg-surface-light dark:bg-surface-dark border-b border-slate-200 dark:border-slate-800 shrink-0 z-20">
                <div class="flex items-center gap-4 lg:hidden">
                    <button id="mobile-menu-btn" class="p-2 -ml-2 text-slate-600 dark:text-slate-300">
                        <span class="material-symbols-outlined">menu</span>
                    </button>
                </div>
                <div class="flex items-center gap-3 ml-auto">
                    <button onclick="window.history.back()"
                        class="flex items-center justify-center px-4 py-2 gap-2 rounded-xl border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all font-bold text-sm">
                        <span class="material-symbols-outlined text-[18px]">arrow_back</span>
                        Voltar
                    </button>
                </div>
            </header>

            <!-- Scrollable Content -->
            <main class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">
                <div class="max-w-7xl mx-auto flex flex-col gap-6">
                    <!-- Headings -->
                    <div class="flex flex-col lg:flex-row lg:items-end justify-between gap-6 pb-2">
                        <div class="flex flex-col gap-2">
                            <div class="flex items-center gap-3">
                                <h1
                                    class="text-3xl md:text-4xl font-black text-text-main dark:text-white tracking-tight">
                                    Controle de Processamento Visual</h1>
                                <span
                                    class="bg-primary/20 text-primary-dark dark:text-primary text-xs px-2 py-1 rounded-md font-bold uppercase tracking-wider">
                                    Monitoramento
                                </span>
                            </div>
                            <p class="text-text-secondary dark:text-gray-400 text-base max-w-2xl">
                                Paciente: <strong id="patient-name-display"
                                    class="text-text-main dark:text-gray-200">Carregando...</strong>
                            </p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="goToNewRecord()"
                                class="flex items-center gap-2 bg-primary hover:bg-primary-dark text-gray-900 px-5 py-2.5 rounded-xl font-bold text-sm shadow-lg shadow-primary/20 transition-all transform active:scale-95">
                                <span class="material-symbols-outlined text-lg">add</span>
                                <span>Nova Avaliação</span>
                            </button>
                        </div>
                    </div>

                    <!-- Stats Overview -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div
                            class="bg-surface-light dark:bg-surface-dark p-5 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm flex flex-col gap-3">
                            <div class="flex justify-between items-start">
                                <div
                                    class="bg-blue-50 dark:bg-blue-900/20 p-2.5 rounded-xl text-blue-600 dark:text-blue-400">
                                    <span class="material-symbols-outlined">description</span>
                                </div>
                            </div>
                            <div>
                                <p class="text-text-secondary dark:text-gray-400 text-sm font-medium mb-1">Total
                                    Avaliações</p>
                                <p id="stat-total-records" class="text-3xl font-black text-text-main dark:text-white">0
                                </p>
                            </div>
                        </div>
                        <div
                            class="bg-surface-light dark:bg-surface-dark p-5 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm flex flex-col gap-3">
                            <div class="flex justify-between items-start">
                                <div
                                    class="bg-purple-50 dark:bg-purple-900/20 p-2.5 rounded-xl text-purple-600 dark:text-purple-400">
                                    <span class="material-symbols-outlined">visibility</span>
                                </div>
                            </div>
                            <div>
                                <p class="text-text-secondary dark:text-gray-400 text-sm font-medium mb-1">Último TVPS
                                    (Std)</p>
                                <p id="stat-last-tvps" class="text-3xl font-black text-text-main dark:text-white">-</p>
                            </div>
                        </div>
                        <div
                            class="bg-surface-light dark:bg-surface-dark p-5 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm flex flex-col gap-3">
                            <div class="flex justify-between items-start">
                                <div
                                    class="bg-orange-50 dark:bg-orange-900/20 p-2.5 rounded-xl text-orange-600 dark:text-orange-400">
                                    <span class="material-symbols-outlined">timer</span>
                                </div>
                            </div>
                            <div>
                                <p class="text-text-secondary dark:text-gray-400 text-sm font-medium mb-1">Último DEM
                                    (Ratio)</p>
                                <p id="stat-last-dem" class="text-3xl font-black text-text-main dark:text-white">-</p>
                            </div>
                        </div>
                        <div
                            class="bg-surface-light dark:bg-surface-dark p-5 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm flex flex-col gap-3 relative overflow-hidden">
                            <div class="absolute right-0 top-0 w-24 h-24 bg-primary/5 rounded-bl-full -mr-4 -mt-4">
                            </div>
                            <div class="flex justify-between items-start relative z-10">
                                <div
                                    class="bg-primary/10 dark:bg-primary/20 p-2.5 rounded-xl text-primary-dark dark:text-primary">
                                    <span class="material-symbols-outlined">calendar_today</span>
                                </div>
                            </div>
                            <div class="relative z-10">
                                <p class="text-text-secondary dark:text-gray-400 text-sm font-medium mb-1">Última
                                    Avaliação</p>
                                <p id="stat-last-date" class="text-xl font-black text-text-main dark:text-white">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content Grid -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left Column: Chart (2/3 width) -->
                        <div class="lg:col-span-2 flex flex-col gap-6">
                            <!-- Chart Section -->
                            <div
                                class="bg-surface-light dark:bg-surface-dark rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm p-6 min-h-[400px]">
                                <div class="flex justify-between items-center mb-6">
                                    <h3 class="text-lg font-bold text-text-main dark:text-white">Evolução TVPS-3 (Score
                                        Padrão)</h3>
                                    <div class="flex gap-2">
                                        <span class="flex items-center gap-1 text-xs font-medium text-slate-500">
                                            <span class="w-3 h-3 rounded-full bg-primary"></span> Pontuação
                                        </span>
                                    </div>
                                </div>

                                <!-- Dynamic Chart Container -->
                                <div id="chart-container"
                                    class="relative h-64 flex items-end justify-between gap-2 md:gap-4 w-full pr-2">
                                    <!-- Loading State -->
                                    <div class="absolute inset-0 flex items-center justify-center text-slate-400">
                                        Carregando gráfico...
                                    </div>
                                </div>
                            </div>

                            <!-- Detailed Breakdown (Optional, keeping simple for now) -->

                        </div>

                        <!-- Right Column: History List (1/3 width) -->
                        <div class="lg:col-span-1 flex flex-col gap-6">
                            <div
                                class="bg-surface-light dark:bg-surface-dark rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm flex flex-col h-full self-start w-full">
                                <div
                                    class="px-6 py-4 border-b border-gray-100 dark:border-gray-800 bg-gray-50/50 dark:bg-gray-800/30">
                                    <h3 class="text-lg font-bold text-text-main dark:text-white">Histórico de Avaliações
                                    </h3>
                                </div>
                                <div id="history-list"
                                    class="flex-1 p-6 flex flex-col gap-4 overflow-y-auto max-h-[600px]">
                                    <p class="text-center text-slate-400 text-sm py-8">Carregando...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="./js/sidebar-loader.js"></script>
    <script type="module">
        import { loadSidebar } from './js/sidebar-loader.js';
        import { supabase } from './js/supabase-client.js';

        // Init
        loadSidebar();

        const params = new URLSearchParams(window.location.search);
        const patientId = params.get('id');

        window.goToNewRecord = () => {
            if (patientId) window.location.href = `Nova Ficha - Processamento Visual.html?patient_id=${patientId}`;
        };

        async function loadData() {
            if (!patientId) {
                alert("Paciente não especificado.");
                return;
            }

            // 1. Fetch Patient Name
            const { data: patient } = await supabase.from('patients').select('full_name').eq('id', patientId).single();
            if (patient) document.getElementById('patient-name-display').textContent = patient.full_name;

            // 2. Fetch Visual Records
            const { data: records, error } = await supabase
                .from('medical_records')
                .select('*')
                .eq('patient_id', patientId)
                .eq('record_type', 'visual')
                .order('date', { ascending: true }); // Oldest first for chart logic

            if (error) {
                console.error(error);
                return;
            }

            const total = records.length;
            document.getElementById('stat-total-records').textContent = total;

            if (total === 0) {
                document.getElementById('chart-container').innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-slate-400 text-sm">Nenhuma avaliação encontrada para gerar gráfico.</div>';
                document.getElementById('history-list').innerHTML = '<p class="text-center text-slate-400 text-sm">Nenhum registro.</p>';
                return;
            }

            // Populate Stats (using the last record)
            const lastRecord = records[records.length - 1];
            const d = JSON.parse(JSON.stringify(lastRecord.data || {})); // Safety clone

            // Extract Metrics
            // TVPS Total (Sum of Scaled Scores or a specific Total field? The form usually calculates a Standard Score)
            // Looking at field IDs: visual_tvps_total_std (if exists)
            // If they are not saved as specific fields but inputs, we access d['visual_tvps_total_std']

            const lastTvps = d['visual_tvps_total_std'] || d['visual_tvps_sum_scaled'] || '-';
            document.getElementById('stat-last-tvps').textContent = lastTvps;

            const lastDem = d['visual_dem_ratio'] || '-';
            document.getElementById('stat-last-dem').textContent = lastDem;

            const lastDate = new Date(lastRecord.date).toLocaleDateString();
            document.getElementById('stat-last-date').textContent = lastDate;

            // Render Chart (TVPS Focus)
            renderChart(records);

            // Render History List (Newest first)
            renderHistory([...records].reverse());
        }

        function renderChart(records) {
            const container = document.getElementById('chart-container');
            container.innerHTML = '';

            // Background lines
            container.innerHTML += `
                <div class="absolute inset-0 flex flex-col justify-between pointer-events-none z-0">
                    <div class="w-full h-px bg-gray-100 dark:bg-gray-800 border-t border-dashed border-gray-200 dark:border-gray-700"></div>
                    <div class="w-full h-px bg-gray-100 dark:bg-gray-800 border-t border-dashed border-gray-200 dark:border-gray-700"></div>
                    <div class="w-full h-px bg-gray-100 dark:bg-gray-800 border-t border-dashed border-gray-200 dark:border-gray-700"></div>
                    <div class="w-full h-px bg-gray-100 dark:bg-gray-800 border-t border-dashed border-gray-200 dark:border-gray-700"></div>
                    <div class="w-full h-px bg-gray-100 dark:bg-gray-800"></div>
                </div>
            `;

            // Normalize scores for height (assuming Standard Score max ~140, min 40? 100 is avg)
            // Let's assume max graph height is 150.
            const maxScore = 150;

            records.forEach((rec, index) => {
                const data = rec.data || {};
                const score = parseFloat(data['visual_tvps_total_std']) || 0;
                let height = (score / maxScore) * 100;
                if (height > 100) height = 100;
                if (height < 5) height = 5; // Min height visibility

                const dateShort = new Date(rec.date).toLocaleDateString(undefined, { day: '2-digit', month: 'short' });

                const barHtml = `
                    <div class="relative z-10 w-full flex flex-col justify-end items-center group cursor-pointer flex-1">
                        <div class="w-full max-w-[40px] bg-primary/70 dark:bg-primary/60 rounded-t-lg transition-all duration-500 group-hover:bg-primary h-[${height}%] relative flex items-start justify-center pt-2 overflow-visible">
                            <span class="text-[10px] font-bold text-slate-800 dark:text-black opacity-0 group-hover:opacity-100 transition-opacity absolute -top-6">${score}</span>
                        </div>
                         <div class="text-[10px] text-gray-400 mt-2 truncate w-full text-center">${dateShort}</div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', barHtml);
            });
        }

        function renderHistory(records) {
            const list = document.getElementById('history-list');
            list.innerHTML = '';

            records.forEach(rec => {
                const date = new Date(rec.date).toLocaleDateString();
                // Try to grab some key summary
                const ratio = rec.data?.visual_dem_ratio || 'N/A';
                const tvps = rec.data?.visual_tvps_total_std || 'N/A';

                const html = `
                    <div class="relative pl-6 group cursor-pointer" onclick="window.location.href='Nova Ficha - Processamento Visual.html?patient_id=${patientId}&record_id=${rec.id}'">
                        <div class="absolute left-0 top-1.5 size-4 bg-primary rounded-full border-2 border-white dark:border-surface-dark z-10"></div>
                        <div class="absolute left-[7px] top-6 bottom-[-10px] w-0.5 bg-gray-100 dark:bg-gray-800 last:hidden"></div>
                        
                        <div class="flex flex-col gap-1 pb-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-bold text-text-main dark:text-white">Avaliação</span>
                                <span class="text-xs text-gray-400">${date}</span>
                            </div>
                            <div class="flex gap-2 mt-1">
                                <span class="text-[10px] bg-blue-50 dark:bg-blue-900/40 text-blue-600 px-2 py-0.5 rounded">TVPS: ${tvps}</span>
                                <span class="text-[10px] bg-orange-50 dark:bg-orange-900/40 text-orange-600 px-2 py-0.5 rounded">DEM: ${ratio}</span>
                            </div>
                             <p class="text-xs text-slate-400 mt-1 line-clamp-2 italic">
                                ${rec.data?.visual_conclusao || 'Sem observações.'}
                            </p>
                        </div>
                    </div>
                 `;
                list.insertAdjacentHTML('beforeend', html);
            });
        }

        loadData();
    </script>
</body>

</html>