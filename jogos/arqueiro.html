<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>O Arqueiro Zen</title>
    <style>
        :root { --bg-color: #000; --primary-color: #FFD700; --text-color: #FFF; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: var(--bg-color); color: var(--text-color); font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        .screen { display: none; width: 100vw; height: 100vh; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; z-index: 1; }
        .screen.active { display: flex; z-index: 2; }
        
        h1 { font-size: 3rem; color: var(--primary-color); margin-bottom: 0.5rem; }
        .instructions-box { background: #222; padding: 20px; border-left: 4px solid var(--primary-color); max-width: 800px; margin-bottom: 20px; color: #ccc; }
        .btn-container { display: flex; gap: 20px; margin-top: 20px; }
        button { background-color: var(--primary-color); color: #000; border: none; padding: 15px 40px; font-size: 1.3rem; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button.secondary { background: transparent; border: 2px solid #555; color: #fff; }
        .back-to-hub { position: absolute; top: 20px; left: 20px; background: transparent; border: 1px solid #555; padding: 10px 20px; color: #aaa; cursor: pointer; }

        /* JOGO */
        #game-area { position: relative; width: 100%; height: 100%; }
        
        #target {
            position: absolute; width: 80px; height: 80px;
            background: var(--primary-color); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 2rem; color: black;
            box-shadow: 0 0 20px var(--primary-color);
            transition: top 1s ease-in-out, left 1s ease-in-out;
        }

        #timer-ring {
            position: absolute; width: 100px; height: 100px;
            border-radius: 50%; border: 5px solid #333;
            border-top-color: #FFF;
            transition: transform 0.1s linear;
            display: none;
        }

        .settings-group { margin-bottom: 20px; width: 100%; max-width: 500px; }
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 1.2rem; }
        select { width: 100%; padding: 10px; background: #333; color: white; border: 1px solid #555; }
        table { width: 100%; max-width: 800px; margin-top: 20px; border-collapse: collapse; background: #222; }
        th, td { padding: 12px; border-bottom: 1px solid #444; text-align: left; }
    </style>
</head>
<body>

    <div id="screen-home" class="screen active">
        <button class="back-to-hub" onclick="window.location.href='../index.html'">â¬… Voltar</button>
        <h1>archer O Arqueiro Zen</h1>
        <div id="patient-display" style="color:var(--primary-color); font-weight: bold; margin-bottom: 20px;">Paciente: ---</div>
        <div class="instructions-box">
            <p><strong>Paciente:</strong> Siga o alvo atÃ© o canto e SEGURE O OLHAR lÃ¡ atÃ© o tempo acabar. NÃ£o mexa a cabeÃ§a!</p>
            <p><strong>Terapeuta:</strong> Se o paciente desviar o olhar, aperte <strong>ESPAÃ‡O</strong> para pausar o tempo (Falha no Hold).</p>
        </div>
        <div class="btn-container">
            <button onclick="startGame()">â–¶ INICIAR</button>
            <button class="secondary" onclick="showScreen('screen-settings')">âš™ ConfiguraÃ§Ãµes</button>
            <button class="secondary" onclick="showHistory()">ðŸ“… Resultados</button>
        </div>
    </div>

    <div id="screen-settings" class="screen">
        <h2>ConfiguraÃ§Ãµes</h2>
        <div class="settings-group">
            <label>Tempo de Hold (SustentaÃ§Ã£o):</label>
            <select id="cfg-hold">
                <option value="3">3 Segundos</option>
                <option value="5">5 Segundos</option>
                <option value="10">10 Segundos</option>
            </select>
        </div>
        <button onclick="showScreen('screen-home')">Salvar</button>
    </div>

    <div id="screen-game" class="screen">
        <div id="game-area">
            <div id="target">ðŸŽ¯</div>
            <div id="timer-ring"></div>
        </div>
        <div style="position:fixed; bottom:10px; color:#555;">EspaÃ§o: Pausar Hold | ESC: Sair</div>
    </div>

    <div id="screen-history" class="screen">
        <h2>Resultados</h2>
        <div id="history-content"></div>
        <button class="secondary" style="margin-top:20px" onclick="showScreen('screen-home')">Voltar</button>
    </div>

    <script>
        const state = { patient: "Visitante", positionsDone: 0, isHolding: false, holdStartTime: 0, holdDuration: 5000, currentPos: 0 };
        const POSITIONS = [
            {x:50, y:50}, // Centro
            {x:10, y:10}, {x:90, y:10}, {x:10, y:90}, {x:90, y:90}, // Cantos
            {x:50, y:10}, {x:50, y:90}, {x:10, y:50}, {x:90, y:50}  // Cruz
        ];
        
        window.onload = function() {
            const p = new URLSearchParams(window.location.search).get('paciente');
            if(p) { state.patient = p; document.getElementById('patient-display').innerText = "Paciente: " + p; }
        };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'screen-history') loadHistory();
        }
        function showHistory() { showScreen('screen-history'); }

        function startGame() {
            state.holdDuration = parseInt(document.getElementById('cfg-hold').value) * 1000;
            state.positionsDone = 0;
            
            showScreen('screen-game');
            moveTo(0); // ComeÃ§a no centro
            setTimeout(() => nextPos(), 2000);
        }

        function nextPos() {
            state.positionsDone++;
            if(state.positionsDone >= POSITIONS.length) { endGame(); return; }
            
            // Randomiza ordem (exceto centro que Ã© 0)
            let next = Math.floor(Math.random() * (POSITIONS.length - 1)) + 1;
            moveTo(next);
        }

        function moveTo(idx) {
            const t = document.getElementById('target');
            const pos = POSITIONS[idx];
            t.style.left = pos.x + '%';
            t.style.top = pos.y + '%';
            
            // Quando chega (aprox 1s de transiÃ§Ã£o), comeÃ§a o Hold
            setTimeout(() => startHold(idx), 1000);
        }

        function startHold(idx) {
            if(idx === 0) return; // Centro nÃ£o precisa de hold longo
            
            state.isHolding = true;
            const ring = document.getElementById('timer-ring');
            const t = document.getElementById('target');
            
            ring.style.display = 'block';
            ring.style.left = (parseFloat(t.style.left) - 3) + '%'; // Ajuste grosseiro px to % conversion tricky, using fixed px is safer but responsive...
            // Let's use getBoundingClientRect for ring positioning
            const rect = t.getBoundingClientRect();
            ring.style.left = (rect.left - 10) + 'px';
            ring.style.top = (rect.top - 10) + 'px';
            
            let progress = 0;
            const interval = 50; // ms
            const step = (interval / state.holdDuration) * 360;
            
            const timer = setInterval(() => {
                if(!state.isHolding) {
                    // Pausado pelo terapeuta
                    return; 
                }
                
                progress += step;
                ring.style.transform = `rotate(${progress}deg)`;
                
                if(progress >= 360) {
                    clearInterval(timer);
                    ring.style.display = 'none';
                    // Volta pro centro para descanso
                    moveTo(0);
                    setTimeout(() => nextPos(), 2000);
                }
            }, interval);
            
            // Salva referÃªncia para cancelar se sair
            state.currentTimer = timer;
        }

        window.addEventListener('keydown', (e) => {
            if(e.code === 'Space') state.isHolding = !state.isHolding; // Toggle Pause
            if(e.code === 'Escape') { clearInterval(state.currentTimer); showScreen('screen-home'); }
        });

        function endGame() {
            let h = JSON.parse(localStorage.getItem('neuro_opt_arqueiro_history') || '[]');
            h.unshift({ date: new Date().toLocaleString('pt-BR'), patient: state.patient, time: (state.holdDuration/1000)+'s' });
            localStorage.setItem('neuro_opt_arqueiro_history', JSON.stringify(h));
            alert("Treino Completo!");
            showScreen('screen-home');
        }

        function loadHistory() {
            const h = JSON.parse(localStorage.getItem('neuro_opt_arqueiro_history') || '[]').filter(x => x.patient === state.patient);
            const div = document.getElementById('history-content');
            if(!h.length) { div.innerHTML = "Sem registros."; return; }
            div.innerHTML = `<table><tr><th>Data</th><th>Tempo de Hold</th></tr>${h.map(i => `<tr><td>${i.date}</td><td>${i.time}</td></tr>`).join('')}</table>`;
        }
    </script>
</body>
</html>