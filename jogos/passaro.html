<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>P√°ssaro na Gaiola</title>
    <style>
        :root { --bg-color: #FFF; --text-color: #333; --primary-color: #2196F3; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: var(--bg-color); color: var(--text-color); font-family: 'Segoe UI', sans-serif; overflow: hidden; user-select: none; }
        .screen { display: none; width: 100vw; height: 100vh; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; z-index: 1; }
        .screen.active { display: flex; z-index: 2; }
        
        h1 { font-size: 3rem; color: var(--primary-color); margin-bottom: 0.5rem; }
        .instructions-box { background: #333; color: #eee; padding: 20px; border-left: 4px solid var(--primary-color); max-width: 800px; margin-bottom: 20px; }
        .btn-container { display: flex; gap: 20px; margin-top: 20px; }
        button { background-color: var(--primary-color); color: #FFF; border: none; padding: 15px 40px; font-size: 1.3rem; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button.secondary { background: transparent; border: 2px solid #555; color: #333; }
        .back-to-hub { position: absolute; top: 20px; left: 20px; background: transparent; border: 1px solid #555; padding: 10px 20px; color: #555; cursor: pointer; }

        /* JOGO */
        #game-area { position: relative; width: 100%; height: 100%; background: #FFF; }
        
        #cage {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; height: 300px;
            border: 10px solid red; border-radius: 20px;
            /* Gaiola Vermelha (Visto pelo olho Cyan/Dir) */
            mix-blend-mode: multiply;
        }
        
        #bird {
            position: absolute; top: 20%; left: 20%; transform: translate(-50%, -50%);
            font-size: 4rem; color: cyan;
            /* P√°ssaro Cyan (Visto pelo olho Red/Esq) */
            mix-blend-mode: multiply;
            transition: top 0.1s, left 0.1s;
        }

        .settings-group { margin-bottom: 20px; width: 100%; max-width: 500px; }
        label { display: block; margin-bottom: 5px; color: #555; font-size: 1.2rem; }
        select { width: 100%; padding: 10px; background: #eee; color: #000; border: 1px solid #aaa; }
        table { width: 100%; max-width: 800px; margin-top: 20px; border-collapse: collapse; background: #eee; }
        th, td { padding: 12px; border-bottom: 1px solid #ccc; text-align: left; }
    </style>
</head>
<body>

    <div id="screen-home" class="screen active">
        <button class="back-to-hub" onclick="window.location.href='../index.html'">‚¨Ö Voltar</button>
        <h1>üê¶ P√°ssaro na Gaiola</h1>
        <div id="patient-display" style="color:var(--primary-color); font-weight: bold; margin-bottom: 20px;">Paciente: ---</div>
        <div class="instructions-box">
            <p><strong>‚ö†Ô∏è Requer √ìculos Anaglifo.</strong></p>
            <p><strong>Paciente:</strong> Diga para onde mover o p√°ssaro at√© ele entrar na gaiola.</p>
            <p><strong>Terapeuta:</strong> Use as <strong>SETAS</strong> para mover o p√°ssaro. Quando o paciente disser que est√° no centro, aperte <strong>ENTER</strong> para ver a posi√ß√£o real.</p>
        </div>
        <div class="btn-container">
            <button onclick="startGame()">‚ñ∂ INICIAR</button>
            <button class="secondary" onclick="showScreen('screen-settings')">‚öô Configura√ß√µes</button>
            <button class="secondary" onclick="showHistory()">üìÖ Resultados</button>
        </div>
    </div>

    <div id="screen-settings" class="screen">
        <h2>Configura√ß√µes</h2>
        <div class="settings-group">
            <label>Inverter Olhos:</label>
            <select id="cfg-invert">
                <option value="no">Gaiola Vermelha / P√°ssaro Ciano</option>
                <option value="yes">Gaiola Ciano / P√°ssaro Vermelho</option>
            </select>
        </div>
        <button onclick="showScreen('screen-home')">Salvar</button>
    </div>

    <div id="screen-game" class="screen">
        <div id="game-area">
            <div id="cage"></div>
            <div id="bird">üê¶</div>
        </div>
        <div style="position:fixed; bottom:10px; color:#888;">Setas: Mover | Enter: Revelar | ESC: Sair</div>
    </div>

    <div id="screen-history" class="screen">
        <h2>Resultados</h2>
        <div id="history-content"></div>
        <button class="secondary" style="margin-top:20px" onclick="showScreen('screen-home')">Voltar</button>
    </div>

    <script>
        const state = { patient: "Visitante", birdX: 20, birdY: 20, isRevealed: false };
        const settings = { invert: 'no' };

        window.onload = function() {
            const p = new URLSearchParams(window.location.search).get('paciente');
            if(p) { state.patient = p; document.getElementById('patient-display').innerText = "Paciente: " + p; }
        };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'screen-history') loadHistory();
        }
        function showHistory() { showScreen('screen-history'); }

        function startGame() {
            settings.invert = document.getElementById('cfg-invert').value;
            
            const cage = document.getElementById('cage');
            const bird = document.getElementById('bird');
            
            if(settings.invert === 'yes') {
                cage.style.borderColor = 'cyan';
                bird.style.color = 'red';
            } else {
                cage.style.borderColor = 'red';
                bird.style.color = 'cyan';
            }
            
            // Posi√ß√£o inicial aleat√≥ria fora do centro
            state.birdX = Math.random() < 0.5 ? 20 : 80; 
            state.birdY = Math.random() < 0.5 ? 20 : 80;
            updateBirdPos();
            
            state.isRevealed = false;
            cage.style.opacity = 1; bird.style.opacity = 1;

            showScreen('screen-game');
        }

        function updateBirdPos() {
            const b = document.getElementById('bird');
            b.style.left = state.birdX + '%';
            b.style.top = state.birdY + '%';
        }

        window.addEventListener('keydown', (e) => {
            if(!document.getElementById('screen-game').classList.contains('active')) return;
            
            // Movimento (Terapeuta)
            const step = 2; // %
            if(e.key === 'ArrowLeft') state.birdX -= step;
            if(e.key === 'ArrowRight') state.birdX += step;
            if(e.key === 'ArrowUp') state.birdY -= step;
            if(e.key === 'ArrowDown') state.birdY += step;
            updateBirdPos();

            if(e.key === 'Enter') checkResult();
            if(e.key === 'Escape') showScreen('screen-home');
        });

        function checkResult() {
            // Centro √© 50%, 50%
            const dx = Math.abs(state.birdX - 50);
            const dy = Math.abs(state.birdY - 50);
            
            let status = "Preciso";
            if(dx > 5 || dy > 5) status = "Deslocado (Foria)";
            if(dx > 15 || dy > 15) status = "Muito Deslocado";

            // Visual Reveal (Mostra uma cruz no centro real)
            const centerMark = document.createElement('div');
            centerMark.style.position = 'absolute'; centerMark.style.top='50%'; centerMark.style.left='50%'; centerMark.style.transform='translate(-50%,-50%)'; centerMark.style.fontSize='3rem'; centerMark.innerText = '+'; centerMark.style.color='black';
            document.getElementById('game-area').appendChild(centerMark);
            
            setTimeout(() => {
                saveResult(status);
                alert(`Alinhamento: ${status}\n(Dist√¢ncia do centro: X:${dx.toFixed(1)}% Y:${dy.toFixed(1)}%)`);
                centerMark.remove();
                showScreen('screen-home');
            }, 500);
        }

        function saveResult(status) {
            let h = JSON.parse(localStorage.getItem('neuro_opt_passaro_history') || '[]');
            h.unshift({ date: new Date().toLocaleString('pt-BR'), patient: state.patient, status: status });
            localStorage.setItem('neuro_opt_passaro_history', JSON.stringify(h));
        }

        function loadHistory() {
            const h = JSON.parse(localStorage.getItem('neuro_opt_passaro_history') || '[]').filter(x => x.patient === state.patient);
            const div = document.getElementById('history-content');
            if(!h.length) { div.innerHTML = "Sem registros."; return; }
            div.innerHTML = `<table><tr><th>Data</th><th>Status</th></tr>${h.map(i => `<tr><td>${i.date}</td><td>${i.status}</td></tr>`).join('')}</table>`;
        }
    </script>
</body>
</html>